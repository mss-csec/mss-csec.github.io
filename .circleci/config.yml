version: 2

jobs:
  build:
    docker:
      - image: circleci/ruby:2.4 # ruby-2.4.0

    environment:
      BUNDLE_INSTALL_DIR: ~/.bundle
      SOURCE_BRANCH: staging
      DEPLOY_BRANCH: master
      USER_EMAIL: markville.compsci@gmail.com
      USER_NAME: MSS CSEC

    working_directory: ~/mss-csec.github.io

    steps:
      # Checkout repository
      - checkout

      # Chmod CI scripts
      - run:
          name: Chmod scripts
          command: chmod +x ./scripts/**/*.sh

      # Restore binary cache
      - restore_cache:
          keys:
            - jessiebin-libpopt0_1.16-10_amd64--rsync_3.1.1-3_amd64

      # Restore bundle cache
      - restore_cache:
          keys:
            - mss-csec-{{ checksum "Gemfile.lock" }}
            - mss-csec-

      # Setup environment
      - run:
          name: Setup environment
          command: |
            ./scripts/ci/setup.sh

      # Save binary cache
      - save_cache:
          key: jessiebin-libpopt0_1.16-10_amd64--rsync_3.1.1-3_amd64
          paths:
            - ./bin

      # Save bundle cache
      - save_cache:
          key: mss-csec-{{ checksum "Gemfile.lock" }}
          paths:
            - ~/.bundle

      # Configure git details
      - run:
          name: Configure git details
          command: |
            git config user.email "$USER_EMAIL"
            git config user.name "$USER_NAME"

      # Deploy
      - deploy:
          command: |
            if [ "${CIRCLE_BRANCH}" == "staging" ]; then
              ./scripts/ci/deploy.sh
            fi

workflows:
  version: 2
  commit:
    jobs:
      - build
          filters:
            branches:
              only:
                - staging
  auto-build:
    triggers:
      - schedule:
          cron: "0 17 * * 5"
          filters:
            branches:
              only:
                - staging
    jobs:
      - build
