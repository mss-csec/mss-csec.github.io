version: 2

jobs:
  build:
    docker:
      - image: circleci/ruby:2.4 # ruby-2.4.0

    environment:
      SOURCE_BRANCH: staging
      DEPLOY_BRANCH: master
      USER_EMAIL: markville.compsci@gmail.com
      USER_NAME: MSS CSEC

    working_directory: ~/mss-csec.github.io

    branches:
      ignore:
        - develop # for now
        - master

    steps:
      # Checkout repository
      - checkout

      # Chmod CI scripts
      - run:
          name: Chmod scripts
          command: chmod +x ./scripts/**/*.sh

      # Restore bundle cache
      - restore_cache:
          keys:
            - mss-csec-{{ checksum "Gemfile.lock" }}
            - mss-csec-

      # Setup environment
      - run:
          name: Setup environment
          command: |
            ./scripts/ci/setup.sh

      # Save bundle cache
      - save_cache:
          key: mss-csec-{{ checksum "Gemfile.lock" }}
          paths:
            - ~/.mss-cache

      # Test Jekyll plugins
      - run:
          name: Test Jekyll plugins
          # So far, we do nothing.
          command: |
            ls -R
            echo "Done testing"

      # Configure git details
      - run:
          name: Configure git details
          command: |
            git config user.email "$USER_EMAIL"
            git config user.name "$USER_NAME"

      # Deploy
      - deploy:
          command: |
            if [ "${CIRCLE_BRANCH}" == "staging" ]; then
              ./scripts/ci/deploy.sh
            fi
